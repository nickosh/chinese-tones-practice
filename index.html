<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>–ü—Ä–∞–∫—Ç–∏–∫–∞ –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Ç–æ–Ω–æ–≤ (–±–µ—Ç–∞)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    type="text/css" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
    crossorigin="anonymous">

<body class="container">

    <h1 class="fs-4 mt-3">–ü—Ä–∞–∫—Ç–∏–∫–∞ –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Ç–æ–Ω–æ–≤ (–±–µ—Ç–∞)</h1>

    <div class="card mt-3 ps-3 pe-3 container">
        <h5 class="fs-5 fw-bold mt-4 mb-1">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∫–∏—Ç–∞–π—Å–∫–∏—Ö —Å–ª–æ–≥–æ–≤:</h5>
        <p class="mt-1 mb-3">
            <button id="btn-playnew" class="btn btn-primary btn-lg mt-2 fs-6" type="button">–ù–æ–≤—ã–π —Å–ª–æ–≥ <span
                    id="btn-playnew-spinner" class="collapse spinner-border spinner-border-sm" role="status"
                    aria-hidden="true"></span></button>
            <input id="btn-repeat" type="button" class="btn btn-secondary btn-lg mt-2 fs-6" value="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å">
            <input id="btn-answer" type="button" class="btn btn-success btn-lg mt-2 fs-6" data-bs-toggle="collapse"
                data-bs-target="#answer" aria-expanded="false" aria-controls="answer" value="–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç">
        </p>

        <h5 class="fs-5 fw-bold mt-4 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç:</h5>
        <div id="user-answers">
            <input id="btn-select1" type="button" class="btn btn-info btn-lg mt-2 me-2 fs-4" value="1 -">
            <input id="btn-select2" type="button" class="btn btn-info btn-lg mt-2 me-2 fs-4" value="2 /">
            <input id="btn-select3" type="button" class="btn btn-info btn-lg mt-2 me-2 fs-4" value="3 v">
            <input id="btn-select4" type="button" class="btn btn-info btn-lg mt-2 me-2 fs-4" value="4 \">
        </div>

        <div id="status" class="mt-4 mb-1 fw-bold"></div>
        <div id="answer" class="collapse mb-3 mt-4">
            <h5 class="fs-5 fw-bold">–û—Ç–≤–µ—Ç:</h5>
            <p id="answer-text">–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ <b>–ù–æ–≤—ã–π —Å–ª–æ–≥</b>.</p>
        </div>
    </div>

    <div class="mt-5 pt-5">
        <h5 class="fs-5 fw-bold">–û–ø–∏—Å–∞–Ω–∏–µ:</h5>
        <p>–≠—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è <a
                href="https://en.wikipedia.org/wiki/Tone_(linguistics)#Asia">—á–µ—Ç—ã—Ä—ë—Ö —Ç–æ–Ω–æ–≤ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</a>.
            <br>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—É–¥–∏–æ –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ <a href="https://tone.lib.msu.edu/">Tone
                Perfect
                Database</a>.
        </p>

        <h2 class="fs-5 fw-bold">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</h2>
        <ol>
            <li>–ù–∞–∂–º–∏—Ç–µ <tt>–ù–æ–≤—ã–π —Å–ª–æ–≥</tt> –∏–ª–∏ –∫–ª–∞–≤–∏—à—É <kbd>P</kbd> –∏–ª–∏ –∫–ª–∞–≤–∏—à—É <kbd>8</kbd> —á—Ç–æ–±—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                —Å–ª—É—á–∞–π–Ω—ã–π –∫–∏—Ç–∞–π—Å–∫–∏–π —Å–ª–æ–≥.</li>
            <li>–ù–∞–∂–º–∏—Ç–µ <tt>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π</tt> –∏–ª–∏ –∫–ª–∞–≤–∏—à—É <kbd>R</kbd> –∏–ª–∏ –∫–ª–∞–≤–∏—à—É <kbd>5</kbd> –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
                –∞—É–¥–∏–æ.</li>
            <li>–ù–∞–∂–º–∏—Ç–µ –æ–¥–Ω—É –∏–∑ —á–µ—Ç—ã—Ä—ë—Ö <tt>–∫–Ω–æ–ø–æ–∫ –æ—Ç–≤–µ—Ç–∞</tt> –∏–ª–∏ –∫–ª–∞–≤–∏—à–∏ <kbd>1</kbd>, <kbd>2</kbd>, <kbd>3</kbd>,
                <kbd>4</kbd> —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ—Ç–≤–µ—Ç.
            </li>
            <li>–ù–∞–∂–º–∏—Ç–µ <tt>–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</tt> –∏–ª–∏ –∫–ª–∞–≤–∏—à—É <kbd>A</kbd> –∏–ª–∏ –∫–ª–∞–≤–∏—à—É <kbd>6</kbd> —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç–≤–µ—Ç (–≤
                –æ—Ç–≤–µ—Ç–µ —Ç–∞–∫ –∂–µ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–∫—É—â–µ–µ –∞—É–¥–∏–æ).</li>
            <li>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤—Å—ë —Ç–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–≤—É–∫–∞.</li>
        </ol>

        <h5 class="fs-5 fw-bold">–°–æ–∑–¥–∞—Ç–µ–ª–∏:</h5>
        <p>Martin Hassman</a>, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ.<br>
            Catherine Ryu, Mandarin Tone Perception & Production Team –∏ Michigan State University Libraries. <a
                href="https://tone.lib.msu.edu/">Tone Perfect: Multimodal Database for Mandarin Chinese</a>.
        </p>

        <h5 class="fs-5 fw-bold">–°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã:</h5>
        <ul>
            <li><a href="https://matthewscholefield.github.io/mandarin-sound-table/">–¢–∞–±–ª–∏—Ü–∞ –∑–≤—É–∫–æ–≤ –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞</a>
            </li>
            <li><a href="https://recursivecorruption.github.io/kuai/">Kuai</a></li>
        </ul>

        <h5 class="fs-5 fw-bold">–û–± –∞–≤—Ç–æ—Ä–µ:</h5>
        <p>–ú–µ–Ω—è –∑–æ–≤—É—Ç <a href="https://www.linkedin.com/in/hassman/">Martin Hassman</a>, —è IT —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –∏–∑ –ß–µ—Ö–∏–∏.
            –ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –∏–∑—É—á–∞—Ç—å —è–∑—ã–∫–∏ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –≤ —É—á—ë–±–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä <a
                href="https://github.com/met/subfilter/wiki">–§–∏–ª—å—Ç—Ä —Å—É–±—Ç–∏—Ç—Ä–æ–≤ –¥–ª—è Netflix</a>).
            –Ø –≤–æ–ª–æ–Ω—Ç—ë—Ä –≤ <a href="https://cesko.digital/en.html">Cesko.Digital</a>.</p>

        <h5 class="fs-5 fw-bold">–ü–µ—Ä–µ–≤–æ–¥:</h5>
        <p></p>–ü–µ—Ä–µ–≤—ë–ª –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –ù–∏–∫–æ–ª–∞–π –®–∏—à–æ–≤, –ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –ø—Ä–æ–µ–∫—Ç–∞ <a href="https://t.me/igorputilov">–ö–∏—Ç–∞–π—Å–∫–∏–π
            –ê–ª—å–º–∞–Ω–∞—Ö</a>.</p>
    </div>

    <footer class="text-center fst-italic pt-4">
        <p>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π <a href="https://github.com/met/chinese-tones-practice">–∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</a> (MIT License). <a
                href="https://github.com/nickosh/chinese-tones-practice/">–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥</a> —Ä—É—Å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏ (MIT License).
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        type="text/javascript" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <script>
        "use strict";

        let appData = { pinyinsToId: undefined, syllableToPinyins: undefined, pinyins: undefined, syllables: undefined, loaded: false };
        let appState = { lastPlayed: null, solved: false, guesses: 0 };


        function loadAppData(appData) {
            let promise1 = fetch("pinyins.json")
                .then(response => {
                    if (response.ok) { return response.json() }
                    else { return Promise.reject({ msg: "Data not loaded", response }) }
                }).then(data => data);

            let promise2 = fetch("syllableToPinyins.json")
                .then(response => {
                    if (response.ok) { return response.json() }
                    else { return Promise.reject({ msg: "Data not loaded", response }) }
                }).then(data => data);

            Promise.all([promise1, promise2]).then((values) => {
                //console.debug("Promise.all", values)
                appData.pinyinsToId = values[0];
                appData.syllableToPinyins = values[1];

                appData.pinyins = processPinyinsToId(appData.pinyinsToId);
                appData.syllables = processSyllableToPinyins(appData.syllableToPinyins);
                appData.loaded = true;
            });
        }


        // Check data validity, return sorted array of pinyins
        function processPinyinsToId(pinyinsToId) {
            let pinyins = [];

            for (let pinyin in pinyinsToId) {
                pinyins.push(pinyin);

                let item = pinyinsToId[pinyin]

                if (item.length < 6) { // TODO there are many of them, I need to find missing sounds and complete dataset
                    //console.log(pinyin, item.length);
                }

                if (item.length > 6) {
                    console.error(pinyin, item.length);
                }
            }

            console.debug("Pinyins loaded", pinyins.length);
            if (pinyins.length != 1640) {  // Expected 1640 (= 410 syllabes * 4 tones)
                console.warn("Unexpected number of pinyins", pinyins.length);
            }

            pinyins.sort();
            return pinyins;
        }


        // Check data validity, return sorted array of syllabes
        function processSyllableToPinyins(syllableToPinyins) {
            let syllables = [];

            for (let syllable in syllableToPinyins) {
                syllables.push(syllable);

                let pinyinsFromSyllable = syllableToPinyins[syllable];
                if (pinyinsFromSyllable.length != 4) {
                    console.error(syllable, pinyinsFromSyllable.length, pinyinsFromSyllable);
                }
            }

            console.debug("Syllables loaded:", syllables.length);
            if (syllables.length != 410) { // expecting 410 syllabes (410 syllabes * 4 tones * 6 voices = 9840 sounds)
                console.warn("Unexpected number of syllables", syllables.length);
            }

            syllables.sort();
            return syllables;
        }


        // pinyin = string
        // tone = 1, 2, 3 or 4
        // voice = FV1, FV2, FV3, FV4, MV1, MV2 or MV3
        // Eg. playVoice("a", 1, "mv1") = play a1 with MV1 = a1_MV1_MP3.mp3
        function playVoice(pinyin, tone, voice, callback) {
            if (pinyin && tone && voice) {
                pinyin = String(pinyin).toLowerCase();
                tone = parseInt(tone);
                voice = String(voice).toUpperCase();

                if (pinyin.match(/^[a-z]{1,6}$/) && voice.match(/^[MF]V[1-3]$/) && tone >= 1 && tone <= 4) {
                    let filename = pinyin + String(tone) + "_" + voice + "_MP3.mp3";
                    console.debug("Play", filename);
                    playFile(filename, callback);
                }
            }
        }

        // Eg. playFile("a1_FV1_MP3.mp3"), playFile("zhuang1_FV2_MP3.mp3")
        function playFile(filename, callback) {
            if (filename && String(filename)) {
                filename = String(filename);

                if (filename.match(/^[a-z]{1,6}[1-4]_[MF]V[1-3]_MP3\.mp3$/)) {
                    let url = "tone_perfect/mp3/" + filename;
                    playURL(url, callback);
                }
            }
        }

        // Eg. playId(1584)
        function playId(id, callback) {
            if (id && parseInt(id)) {
                id = parseInt(id);
                if (id > 1000 && id < 12000) {
                    const url = `https://tone.lib.msu.edu/tone/${id}/datastream/PROXY_MP3`;
                    console.debug("Play", id);
                    playURL(url, callback);
                }
            }
        }

        // Eg. playURL("https://tone.lib.msu.edu/tone/1584/datastream/PROXY_MP3")
        function playURL(url, callback) {
            if (url) {
                console.debug("Play", url);
                let audio = new Audio(url);
                audio.play().then(e => {
                    if (callback) { callback(); }
                });
            }
        }


        function chooseRandomPinyin() {
            let syllables = appData.syllables;
            let randomSyllable = syllables[Math.floor(Math.random() * syllables.length)];

            let syllableToPinyins = appData.syllableToPinyins;
            let randomToneIndex = Math.floor(Math.random() * syllableToPinyins[randomSyllable].length); // toneindex is zero-based. tone == toneindex+1
            let randomPinyin = syllableToPinyins[randomSyllable][randomToneIndex];
            let pinyinsToId = appData.pinyinsToId;

            //console.log(randomPinyin);
            //console.log(pinyinsToId[randomPinyin]);

            // We have random pinyin, choose random voice
            if (pinyinsToId[randomPinyin]) {
                let randomVoiceSet = pinyinsToId[randomPinyin];
                let randomVoiceIndex = Math.floor(Math.random() * randomVoiceSet.length);
                let randomId = randomVoiceSet[randomVoiceIndex];
                //console.log(randomId);
                //playId(randomId); return ...
                return { "syllabe": randomSyllable, "tone": indexToTone(randomToneIndex), "pinyin": randomPinyin, "id": randomId };
            }
            else {
                console.warn("Cannot find pinyin in pinyinsToId:", randomPinyin);
                return null;
            }
        }

        function playRandom() {
            let p = chooseRandomPinyin();
            console.debug(p);
            playId(p.id);

        }

        // Simple HTML text sanitizer
        function sanitize(text, removeChar) {
            if (typeof (text) == "number") {
                text = String(text);
            }

            if (removeChar) {
                text = text.replaceAll(removeChar, "");
            }

            return text.replaceAll("&", "&amp;").replaceAll("<", "&lt;");
        }


        // syllableToPinyins.json has strange order of tones
        // Here convert order (array index) to tone number
        function indexToTone(index) {
            return [4, 2, 1, 3][index];
        }


        function playNew() {
            if (!appData || !appData.loaded) {
                console.log("Can't play, no appData.");
                return;
            }

            let p = chooseRandomPinyin();
            appState.lastPlayed = p;

            resetAnswers();
            let answer = "<b>" + sanitize(p.pinyin + " " + String(p.tone)) + "</b> <a href=\"https://tone.lib.msu.edu/tone/" + sanitize(String(p.id), "\"") + "\" target=\"_blank\">" + sanitize(p.syllabe + " " + String(p.id)) + "</a>";
            setAnswer(answer);

            // Show spinning wheel during audio download
            showSpinningWheel();
            playId(p.id, function () { hideSpinningWheel(); });
        }


        function playLastAgain() {
            if (appState.lastPlayed) {
                playId(appState.lastPlayed.id)
            }
        }

        function showSpinningWheel() {
            let loadingEl = document.getElementById("btn-playnew-spinner");
            loadingEl.classList.remove("collapse");

        }

        function hideSpinningWheel() {
            let loadingEl = document.getElementById("btn-playnew-spinner");
            loadingEl.classList.add("collapse");
        }

        function resetAnswers() {
            let answerEl = document.getElementById("answer");
            let statusEl = document.getElementById("status");
            let btnSelect1 = document.getElementById("btn-select1");
            let btnSelect2 = document.getElementById("btn-select2");
            let btnSelect3 = document.getElementById("btn-select3");
            let btnSelect4 = document.getElementById("btn-select4");
            let buttons = [btnSelect1, btnSelect2, btnSelect3, btnSelect4];

            answerEl.classList.remove("show"); // Hide answer
            statusEl.innerHTML = "";

            buttons.forEach(element => { element.classList.add("btn-info"); element.classList.remove("btn-danger"); element.classList.remove("btn-success"); });

            appState.solved = false;
            appState.guesses = 0;
        }

        function setAnswer(text) {
            let answerEl = document.getElementById("answer-text");
            answerEl.innerHTML = text;
        }

        // Select answer 1-4
        function selectAnswer(index) {
            if (appState.solved || !appState.lastPlayed) {
                return; // already solved or didn't play tone yet
            }

            let answerEl = document.getElementById("answer");
            let statusEl = document.getElementById("status");
            let btnSelect1 = document.getElementById("btn-select1");
            let btnSelect2 = document.getElementById("btn-select2");
            let btnSelect3 = document.getElementById("btn-select3");
            let btnSelect4 = document.getElementById("btn-select4");

            let buttons = [btnSelect1, btnSelect2, btnSelect3, btnSelect4]
            appState.guesses++;

            // Correct answer
            if (index === appState.lastPlayed.tone) {
                buttons[index - 1].classList.add("btn-success");
                buttons[index - 1].classList.remove("btn-info");

                answerEl.classList.add("show"); // Show answer

                if (appState.guesses > 1) {
                    if (appState.guesses < 4) {
                        statusEl.innerHTML = "–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üòÄ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫: " + appState.guesses;
                    }
                    else {
                        // Too bad
                        statusEl.innerHTML = "–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ù–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫: " + appState.guesses + " üòû";
                    }

                }
                else {
                    statusEl.innerHTML = "–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üòÄ";
                }

                appState.solved = true;
            }
            // Incorrect answer
            else {
                buttons[index - 1].classList.add("btn-danger");
                buttons[index - 1].classList.remove("btn-info");

                statusEl.innerHTML = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞! üòû";
            }
        }

        function initUI() {
            document.getElementById("btn-playnew").onclick = function (event) {
                playNew();
                return false;
            }

            document.getElementById("btn-repeat").onclick = function (event) {
                playLastAgain();
                return false;
            }

            document.getElementById("btn-select1").onclick = function (event) {
                selectAnswer(1);
                return false;
            }

            document.getElementById("btn-select2").onclick = function (event) {
                selectAnswer(2);
                return false;
            }
            document.getElementById("btn-select3").onclick = function (event) {
                selectAnswer(3);
                return false;
            }
            document.getElementById("btn-select4").onclick = function (event) {
                selectAnswer(4);
                return false;
            }


            document.addEventListener("keydown", function (event) {
                let keyName = event.key;
                let keyCode = event.code;
                //console.log("KEYDOWN", event.key, event.keyCode, event.code);

                if (keyCode === "Digit8" || keyCode === "Numpad8" || (keyCode === "KeyP" && !event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey)) {
                    playNew();
                }
                else if (keyCode === "Digit5" || keyCode === "Numpad5" || (keyCode === "KeyR" && !event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey)) {
                    playLastAgain();
                }
                else if (keyCode === "Digit6" || keyCode === "Numpad6" || (keyCode === "KeyA" && !event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey)) {
                    document.getElementById("btn-answer").click();
                }
                else if (keyCode === "Digit1" || keyCode === "Numpad1") {
                    document.getElementById("btn-select1").click();
                }
                else if (keyCode === "Digit2" || keyCode === "Numpad2") {
                    document.getElementById("btn-select2").click();
                }
                else if (keyCode === "Digit3" || keyCode === "Numpad3") {
                    document.getElementById("btn-select3").click();
                }
                else if (keyCode === "Digit4" || keyCode === "Numpad4") {
                    document.getElementById("btn-select4").click();
                }

            }, false);
        }


        loadAppData(appData);
        initUI();

    </script>
